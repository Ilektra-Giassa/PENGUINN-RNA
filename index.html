<!DOCTYPE html>
<HTML lang="en">
  <HEAD>
<style>
.seqtext {
  font-family: Georgia, serif;
  white-space: pre;
  margin: 1em 0;
}

html,
body {
  padding: 0;
  background: #fff;
  color: #778899;
  float: center;
}

h1 {
  width: 20%;
  font-family: "Verdana", sans-serif;
  font-size: 3em;
  font-weight: 100;
  text-transform: none;
  letter-spacing: 3px;
  text-align: center;
  color: #364e65;
  padding: 0;
  margin-left: auto;
  margin-right: auto;
  text-shadow: 1px 1px 2px;
}

.tab {
  width: 80%;
  font-family: 'Times New Roman', serif;
  margin: auto;  
}


.bar-button {
  background-color: #4682B4;
  color: white;
  padding: 15px 30px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  font-weight: bold;
  font-variant-caps: petite-caps;
  border: 1px solid #4682B4;
}
.bar-button, .bar-button0 {
  float:left;
  }
  
.button1:hover {
  box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.24), 0 17px 50px 0 rgba(0, 0, 0, 0.19);
  background-image: radial-gradient(#6495ED, #4682B4, #4682B4);
}

.bar .bar-button {
  float: left;
}

.bar-button0 {
  background-color: #4682B4;
  font-stretch: ultra-expanded;
  font-family: Garamond, serif;
  font-size: 15px;
  /* Navy blue */
  color: white;
  padding: 5px 5px;
  text-align: center;
  text-decoration: none;
  font-weight: bolder;
  font-weight: bold;
  border: 1px solid #4682B4;
}

.bar .bar-button0 {
  float: left;
}
.bar .bar-button:active {
  background-color: #4682B4;
  box-shadow: 0 5px #666;
}

table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}

tr:nth-child(even) {
  background-color: #dddddd;
}
   
</style>

    <TITLE>PENGUINN RNA</TITLE>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"> </script>
  </HEAD>
  <BODY>
	<div class="bar buttons">
	  <button style="width:10%"class="bar-button0 button0">PENGUINN RNA</button>
	  <button style="width:45%" class="bar-button button1" onclick="openTab('about')">About</button>
      <button style="width:45%" class="bar-button button1" onclick="openTab('single')">Queries</button>
    </div>
	<br /><br /><br /><br />
	
	<div id="about" class="bar tab">
      <FORM method="post" enctype="multipart/form-data" ><br />
	<h4><strong>About PENGUINN RNA</strong></h4>
		<p>The <strong>PENGUINN RNA </strong> web interface predicts the potential of a sequence to fold into a G-quadruplex. To use our machine learning method, first choose the size of the input by clicking either on <i><strong>Single Sequence</strong></i> or on <i><strong>Multiple Sequences</strong></i>).</p>
	<DIV class="prob1" , id="prob1"><p>For more info about PENGUINN RNA, click <A href="https://github.com/ML-Bioinfo-CEITEC/PENGUINN-RNA" target="_blank">here</A>.</p></DIV><br/>
	<strong>Key</strong><br/>For the interpretation of the miRBind scores:
	<br/>Scores highlighted in <span  style='color:green;'>green</span> exceed the sensitive threshold (0.5) of PENGUINN RNA.<br/> Scores highlighted in <span  style='color:blue;'>blue</span> exceed the precise threshold (0.9) of PENGUINN RNA.
    </FORM>
    </div>
	
	<div id="single" class="bar tab" style="display:none">
     <FORM>
      <LABEL class="radio-inline">
        <INPUT type="radio" name="optradio" id="opt_single" onclick="checkedSingle();" checked>Single sequence
        </LABEL>
      <LABEL class="radio-inline">
        <INPUT type="radio" name="optradio" id="opt_fasta" onclick="checkedFasta();">Multiple sequences (FASTA)
        </LABEL>
      <LABEL class="radio-inline">
        <INPUT type="radio" name="optradio" id="opt_multiline" onclick="checkedMultiline();">Multiple sequences (line separated)
        </LABEL>
    </FORM>
    <DIV><TEXTAREA name="text1" id="text1" style="width:90%;height:150px;" 
      placeholder="Copy your DNA sequence here (20 - 200bp sequence consisting of A, C, G, T and N characters). 

Example: 
GGAAGACCCAATCGGACCGGGAGGTCCGGGGAGACGTGTCGGGGATCGGG"></TEXTAREA></DIV>
    <FORM>
      <LABEL class="radio-inline">
        <INPUT type="radio" name="optradio" id="opt_textoutput" checked>Text output
      </LABEL>
      <LABEL class="radio-inline">
        <INPUT type="radio" name="optradio" id="opt_tabularoutput">Tabular output
      </LABEL>
    </FORM><BR/>
    <DIV><BUTTON type="button" onclick="makePrediction();">Predict</BUTTON>
    <BUTTON type="button" onclick="loadExample();">Load Example</BUTTON></DIV><BR/>
    <DIV class = "prob", id = "prob2">For more info about Penguinn and contact to its developers, see <A href="https://github.com/ML-Bioinfo-CEITEC/penguinn" target="_blank" rel="noopener noreferrer">https://github.com/ML-Bioinfo-CEITEC/penguinn</A>.</DIV>
	</div>
<script>


function prolongSequence(sequence, size) {  
  const Ncount = size - sequence.length;
  const leftNcount = Math.floor(Math.random() * (Ncount+1));
  const rightNcount = Ncount - leftNcount;
  const leftNs = "N".repeat(leftNcount);
  const rightNs = "N".repeat(rightNcount);
  return leftNs.concat(sequence, rightNs);
}

function validateSequence(sequence, minSize=20, maxSize=200) {
  if (sequence.length > maxSize) {
    return 'The sequence is too long. The sequence needs to be shorter or equal to '.concat(maxSize, '.');
  } else if (sequence.length < minSize) {
    return 'The sequence is too short. The sequence needs to be longer or equal to '.concat(minSize, '.');
  } else if ('' != sequence.replace(/A/g,'').replace(/T/g,'').replace(/U/g,'').replace(/C/g,'').replace(/G/g,'').replace(/N/g,'')) {
    return 'The sequence must consist only of "A", "C", "T", "G" and "U" characters.';
  } else {
    return '';
  }
}

function getAverage(array){
  const n = array.length
  const mean = array.reduce((a, b) => a + b) / n
  return mean
}

// copied from https://stackoverflow.com/a/53577159
function getStandardDeviation(array) {
  const n = array.length
  const mean = array.reduce((a, b) => a + b) / n
  return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n)
}

function formatText(sequence, results, error=0, seq_name='') {
  console.log("formatting output..." + error);

  var output = "<br/><b>Input:</b><seqtext>";
  if (seq_name!='') {
    output = output.concat(">", seq_name, "<br/>");
  }

  output = output.concat(sequence.replace(/(.{50})/g,"$1<br/>"), "</seqtext>");
  if (error) {
    output = output.concat("<b>Error:</b><br/><br/>", results, '<br/><br/><br/>');
  } else {

    result = getAverage(results).toFixed(3);
    stdev = getStandardDeviation(results);
    twoerr = (2 * stdev / Math.sqrt(results.length - 1)).toFixed(3);
    if (twoerr < 0.001) {
      twoerr = '<0.001'
    }

    if (result > 0.85) {
      output = output.concat("<b>Output:</b><br/><br/>Probability of G4 complex =   ", result, ' (±', twoerr,'), higher than PENGUINN Precise score threshold.<br/><br/><br/>');
    } else if (result > 0.5) {
      output = output.concat("<b>Output:</b><br/><br/>Probability of G4 complex =   ", result, ' (±', twoerr,'), higher than PENGUINN Sensitive score threshold.<br/><br/><br/>');
    } else {
      output = output.concat("<b>Output:</b><br/><br/>Probability of G4 complex =   ", result, ' (±', twoerr,'), sequence does not pass PENGUINN threshold.<br/><br/><br/>');
    }  
  }

  return output
}

function formatTable(sequence, results, error=0, seq_name='') {
  console.log("formatting output as CSV..." + error);

  var output = "";
  if (seq_name!='') {
    output = output.concat(seq_name, ", ");
  }

  output = output.concat(sequence, ", ");
  if (error) {
    output = output.concat("NA, NA");
  } else {
    result = getAverage(results).toFixed(6);
    stdev = getStandardDeviation(results);
    twoerr = (2 * stdev / Math.sqrt(results.length - 1)).toFixed(6);
    output = output.concat(result, ', ', twoerr);
  }
  output = output.concat("<br/>");

  return output
};

function formatOutput(sequence, results, error=0, seq_name='', output_type='text') {
  if (output_type=='text') {
    return formatText(sequence, results, error, seq_name) 
  } else {
    return formatTable(sequence, results, error, seq_name) 
  }
};

function oneHot(s200) {
  // one-hot encoding
  const t = s200.replace(/A/g,'0').replace(/T/g,'1').replace(/C/g,'2').replace(/G/g,'3').replace(/N/g,'9')
  const y = tf.oneHot(tf.tensor1d(t.split(''),'int32'),4);
  return y.reshape([1,200,4]);
}

function simpleSeq(x) {
  return {name: '', seq: x};
}

function setTextArea(text='') {
  var ta = document.getElementById('text1');
  ta.value = '';
  ta.placeholder = text;
}

function checkedSingle(){
  setTextArea("Copy your DNA sequence here (20 - 200bp sequence consisting of A, C, G, T and N characters).\n\nExample:\nGGAAGACCCAATCGGACCGGGAGGTCCGGGGAGACGTGTCGGGGATCGGG");
}

function checkedFasta(){
  setTextArea("Copy your FASTA formatted DNA sequences here.\n\nExample:\n>Seq1\nGGAAGACCCAATCGGACCGGGAGGTCCGGGGAGACGTGTCGGGGATCGGG\n>Seq2\nTGTCAGAAACTTATATTGGGTGATTTCATTTTTAAAAGTAACCAAAGTGAAAAAT");
}

function checkedMultiline(){
  setTextArea("Copy your DNA sequences here (each on a separate line).\n\nExample:\nGGAAGACCCAATCGGACCGGGAGGTCCGGGGAGACGTGTCGGGGATCGGG\nTGTCAGAAACTTATATTGGGTGATTTCATTTTTAAAAGTAACCAAAGTGAAAAAT");
}

function loadExample(){
  console.log("making example...");
  if(document.getElementById('opt_single').checked) {
    example = "GAGACACCACTACAGTTAGCAGTGAGTGTAAAATAATGAGTGTCAGAAACTTATATTGGGTGATTTCATTTTTAAAAGTAACCAAAGTGAAAAATGAAGCCTTGCGTTTTTGCTTAAATGATTTACAAAAAATATTTGATGTCCATCCTGGGATAGGGAATTCCTCCCCCATAACTTTGAAAGTGCAGTTGCTTCATTCC"
  }
  if(document.getElementById('opt_fasta').checked) {  
    example = ">negative_example\nGAGACACCACTACAGTTAGCAGTGAGTGTAAAATAATGAGTGTCAGAAACTTATATTGGGTGATTTCATTTTTAAAAGTAACCAAAGTGAAAAATGAAGCCTTGCGTTTTTGCTTAAATGATTTACAAAAAATATTTGATGTCCATCCTGGGATAGGGAATTCCTCCCCCATAACTTTGAAAGTGCAGTTGCTTCATTCC\n>positive_example\nGAAGAGACCAAGACGGAAGACCCAATCGGACCGGGAGGTCCGGGGAGACGTGTCGGGGATCGGGACTTGACTGTGCTTACCAAAGGACCTAACGGAGGGGTCCATAGGAGTCTTGCGGGACTCCCTGGCACTGGAGTAGTATCGACATAAGGGTCACGGACGTTCCATTTAGTGAGCCATTTATAAACCACTATC\n>wrong_input\nFFGHAAJ"
  }
  if(document.getElementById('opt_multiline').checked) {  
    example = "GAGACACCACTACAGTTAGCAGTGAGTGTAAAATAATGAGTGTCAGAAACTTATATTGGGTGATTTCATTTTTAAAAGTAACCAAAGTGAAAAATGAAGCCTTGCGTTTTTGCTTAAATGATTTACAAAAAATATTTGATGTCCATCCTGGGATAGGGAATTCCTCCCCCATAACTTTGAAAGTGCAGTTGCTTCATTCC\nGAAGAGACCAAGACGGAAGACCCAATCGGACCGGGAGGTCCGGGGAGACGTGTCGGGGATCGGGACTTGACTGTGCTTACCAAAGGACCTAACGGAGGGGTCCATAGGAGTCTTGCGGGACTCCCTGGCACTGGAGTAGTATCGACATAAGGGTCACGGACGTTCCATTTAGTGAGCCATTTATAAACCACTATC"
  }  

  var textarea = document.getElementById('text1');
  textarea.value = example;
};

async function makePrediction() {
  
  // get HTML elements
  var prob = document.getElementById('prob2');
  prob.innerHTML = '';
  var txt = document.getElementById('text1').value;
  
  console.log("model loading...");

  // clear the model variable
  var model = undefined;
  // load model
  model = await tf.loadLayersModel("https://raw.githubusercontent.com/ML-Bioinfo-CEITEC/PENGUINN-RNA/gh-pages/assets/model.json");
  console.log("model loaded...");

  // parse input text into the array of sequences
  var seqArray = [];
  if(document.getElementById('opt_single').checked) {
    const seq = txt.replace(/\r?\n|\r/g,'').replace(/\s/g, '');
    seqArray = [simpleSeq(seq)];
  }
  if(document.getElementById('opt_fasta').checked) {
    var fasta = require("biojs-io-fasta");
    seqArray = fasta.parse(txt);
  }  
  if(document.getElementById('opt_multiline').checked) {
    seqArray = txt.split(/\r?\n/).map(simpleSeq);
  }

  if(document.getElementById('opt_tabularoutput').checked) {
    var output_type="tabular";
    if(document.getElementById('opt_fasta').checked) {
      prob.innerHTML += '<b>Name, </b>'
    }
    prob.innerHTML += '<b>Sequence, G4_Probability, Twice_SE</b><br />';
  }
  if(document.getElementById('opt_textoutput').checked) {
    var output_type="text";
  }
  
  
  // process the array of sequences
  for (var i = 0; i < seqArray.length; i++) {  
    
    var s = seqArray[i].seq.toUpperCase();
    
    // check the sequence format
    const validation = validateSequence(s, 20, 200)
    if (validation != '') {
      console.log("wrong input...");
      prob.innerHTML += formatOutput(s, validation, 1, seqArray[i].name, output_type);
      continue;
    }
    var s2 = s;

    const Ntries = 100; // number of tries 
    var results = [];
    for (j=0; j<Ntries; j++) {
      if (s.length < 200) {
        s2 = prolongSequence(s, 200);
      }  
  
      // from string to one-hot array
      var a = oneHot(s2);
  
      // inference
      results.push(parseFloat(model.predict(a).asScalar().dataSync()));
    }

    // output
    prob.innerHTML += formatOutput(s, results, 0, seqArray[i].name, output_type);
  }  
  
}

// Example(s): 
// GAGACACCACTACAGTTAGCAGTGAGTGTAAAATAATGAGTGTCAGAAACTTATATTGGGTGATTTCATTTTTAAAAGTAACCAAAGTGAAAAATGAAGCCTTGCGTTTTTGCTTAAATGATTTACAAAAAATATTTGATGTCCATCCTGGGATAGGGAATTCCTCCCCCATAACTTTGAAAGTGCAGTTGCTTCATTCC
// 0.00069759286
// NNNGAAGAGACCAAGACGGAAGACCCAATCGGACCGGGAGGTCCGGGGAGACGTGTCGGGGATCGGGACTTGACTGTGCTTACCAAAGGACCTAACGGAGGGGTCCATAGGAGTCTTGCGGGACTCCCTGGCACTGGAGTAGTATCGACATAAGGGTCACGGACGTTCCATTTAGTGAGCCATTTATAAACCACTATCNN
// 0.87126887

function openTab(tabName) {
  var i;
  var x = document.getElementsByClassName("tab");
  for (i = 0; i < x.length; i++) {
    x[i].style.display = "none";
  }
  document.getElementById(tabName).style.display = "block";
}

	</script>
		
  </BODY>

</HTML>
